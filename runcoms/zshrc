#!/usr/bin/zsh
#
# Executes commands at the start of an interactive session.
#
# Authors:
#   Sorin Ionescu <sorin.ionescu@gmail.com>
#   James Brown <drightkayorent@gmail.com>
#

# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

##############################
# Customize to your needs... #
##############################

#####################################
# Read zsh configuration from couchdb

checkNotFound () {
    [[ $(echo $* | jq .error) =~ not_found ]]
}

# config database location
zc=http://127.0.0.1:5984/zshconfig

# default aliases, configure others in futon
read -d '' alias_doc <<EOF
{"aliases": {"zc": "cd ~/zprezto/runcoms",
             "ec": "cd ~/.emacs.d"}}
EOF

# Ensure database is created
checkNotFound $(curl -sS $zc) && curl -X PUT $zc

# Ensure aliases document is created
aliasdoc=$(curl -sS $zc/aliases)
checkNotFound $aliasdoc && aliasdoc=$(curl -sS -X PUT $zc/aliases -d $alias_doc)

std_aliases=$(echo "$aliasdoc" | jq '.aliases')
aliaskeys=$(echo "$std_aliases" | jq 'keys' | jq '.[]')

echo "$aliaskeys" | while read -r key
do
    key=$(echo $key | tr -d '[:space:]"')
    value=$(echo $std_aliases | jq .$key | tr -d "\'\"\n\r")
    alias $key=$value
done



if [[ `uname` =~ MSYS_NT ]]; then
    alias ex='explorer .'

    if [[ `whoami` =~ student ]]; then
        alias pl='cd c:/Repos/portal/portal'
        alias ga='cd c:/Repos/Glass\ App'
        alias dl='cd c:/Users/Student/Downloads'
        alias dr='cd c:/Users/Student/Dropbox'
        alias rp='cd c:/Repos'

        function pcp {
            scp $* 'host'
        }
    else
        alias dl='cd f:/Media/Downloads'
        alias dr='cd f:/Media/Dropbox'
        alias drpl='ssh freebsd@104.236.115.35'
    fi

else
    alias dl='cd ~/Downloads'
fi

########################################
# Ensure that the editor is set properly
export VISUAL=emacsclient
export EDITOR=emacsclient

# Should probably investigate why I can't use the 'function'
# syntax for this.
alias e=e

alias msysupdate='pacman --needed -S bash pacman msys2-runtime'
function zupdate {
    setopt EXTENDED_GLOB
    for rcfile in "${ZDOTDIR:-$HOME}"/.zprezto/runcoms/^README.md(.N); do
        rm -f "${ZDOTDIR:-$HOME}/.${rcfile:t}"
        ln -s "$rcfile" "${ZDOTDIR:-$HOME}/.${rcfile:t}"
    done
    source ~/.zprezto/runcoms/zshrc
}
