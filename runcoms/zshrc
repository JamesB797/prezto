#!/usr/bin/zsh
#
# Executes commands at the start of an interactive session.
#
# Authors:
#   Sorin Ionescu <sorin.ionescu@gmail.com>
#   James Brown <drightkayorent@gmail.com>
#

# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

##############################
# Customize to your needs... #
##############################

#####################################
# Read zsh configuration from couchdb
config="$HOME/.local-config/zsh.ini"

# Ensure config file exists
if [[ ! -a "$config" ]]; then
    >"$config" <<EOF
[aliases]
zc=cd ~/zprezto/runcoms
ec=cd ~/.emacs.d
EOF
fi

inaliases=false
cat "$config" | while read -r line  # Can I do this without cat?
do
    # Alias lines in aliases section
    if [[ "$inaliases" = true && "$line" =~ "=" ]]; then
        alias "$line"
    fi

    # Ignore others
    if [[ "$line" =~ "^\[aliases\]$" ]]; then
        inaliases=true
    elif [[ "$line" =~ "^\[.*\]$" ]]; then
        inaliases=false
    fi
done

########################################
# Ensure that the editor is set properly
export VISUAL=emacsclient
export EDITOR=emacsclient

# Should probably investigate why I can't use the 'function'
# syntax for this.
alias e=e

alias msysupdate='pacman --needed -S bash pacman msys2-runtime'
function zupdate {
    setopt EXTENDED_GLOB
    for rcfile in "${ZDOTDIR:-$HOME}"/.zprezto/runcoms/^README.md(.N); do
        rm -f "${ZDOTDIR:-$HOME}/.${rcfile:t}"
        ln -s "$rcfile" "${ZDOTDIR:-$HOME}/.${rcfile:t}"
    done
    source ~/.zprezto/runcoms/zshrc
}
